{% extends "master.html" %}
{% set body_class = "tourney-context" %}

{% block script %}
    {% autoescape false %}
    <script>
        var gamesJSON = {{g.gamesJSON}};
        function matchModel() {
            var self = this;

            self.games = ko.observableArray();
            for (var i=0;i<gamesJSON.length;i++) {
                self.games().push(ko.mapping.fromJS(gamesJSON[i]));
                console.log(gamesJSON[i]);
            }

            self.addInning = function(game) {
                game.innings(game.innings()+1)
                self.saveGame(game);
            }
            self.subtractInning = function(game) {
                if (game.innings() > 0) {
                    game.innings(game.innings()-1)
                    self.saveGame(game);
                }
            }

            self.saveGame = function(game) {
                $.ajax("/tournament/match/game", {
                    "contentType": "application/json; charset=UTF-8",
                    "type": "POST",
                    "data": ko.toJSON(game), 
                    "complete": function(data) {
                        var i=0, gameUpdate = ko.mapping.fromJSON(data.responseText)
                        for (;i<self.games().length;i++) {
                            if (self.games()[i].id() == gameUpdate.id()) {
                                self.games()[i] = gameUpdate;
                            }
                        }
                    }
                })
            }

        }


        $(function() {
            ko.applyBindings(new matchModel());
        });
            

    </script>
    {% endautoescape %}
{% endblock %}

{% block body %}

    {% include 'tourney_header.html' %}
    <h2>Match #{{ g.match.ordinal }}</h2>
    <div class="opponents">
        <div class="row">
            <div class="col-xs-5">
                <h4>HOME<br>
                <small>{{ g.home_players[0].firstname}} {{ g.home_players[0].lastname}} ({{ g.home_players[0].handicap }})</small>
                </h4>
            </div>
            <div class="col-xs-1">
                <h4>{{ g.match.home_games }}</h4>
            </div>
            <div class="col-xs-5">
                <h4>AWAY<br>
                <small>{{ g.away_players[0].firstname}} {{ g.away_players[0].lastname}} ({{ g.away_players[0].handicap }})</small>
                </h4>
            </div>
            <div class="col-xs-1">
                <h4>{{ g.match.away_games }}</h4>
            </div>
        </div>
    </div>

    <div class="games">
        <form data-bind="foreach: {data: games, as: 'game'}">

            <div data-bind="css: {'panel': true, 'panel-primary': game.in_progress, 'panel-default': !game.in_progress}">
                <div class="panel-heading">
                    <h3 class="panel-title">Game <span data-bind="text: game.ordinal"></span></h3>
                    <div class="in-progress" data-bind="if: game.in_progress">IN PROGRESS</div>
                </div>
                <div class="panel-body">
                    <span data-bind="text: game.innings">0</span>
                <button type="button" class="btn-add-inning" data-bind="click: $root.addInning">Add Inning</button>
                </div>
            </div>

        </form>
    </div>

    <form action="{{ url_for('match', mid=g.match.id) }}" method="post" role="form">
        <div class="row">
            <div class="col-xs-6 text-center">
                <button type="submit" class="btn-new-game" name="new_match" value="start_game">Start New Game</button>
            </div>
            <div class="col-xs-6 text-center">
                <button type="submit" class="btn-end-match" name="end_tourney" value="end_match">End Match</button>
            </div>
        </div>
    </form>

{% endblock %}

