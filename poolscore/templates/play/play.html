{% extends "master.html" %}
{% set body_class = "root-context" %}

{% block script %}
<script type="text/javascript">
function NewTourneyModel() {
    var self = this,
    userId = "{{session.user_id}}",
    tourney_id = "{{ tourney_id }}",
    matchDefaultContent = {
        "id": -1 
    },
    initTemplateOptions = {
        "name": ""
    },
    topBlockTemplateOptions = {
        "name": "top_template",
        "data": self
    },
    mainBlockTemplateOptions = {
        "name": "match_list_template",
        "data": self
    },
    api = (function() {
        var ep, root = "/api/v1.0/";

        function _m(n,p) {
            return {"path":root + p,"node": n};
        }

        function _p(endpoint) {
            var i=1, p;
            if (ep[endpoint] === undefined) return "";
            p = ep[endpoint].path;

            while(i < arguments.length) {
                p = p.replace(/%s/,arguments[i++]);
            }

            return p;
        }

        function _n(endpoint) {
            if (ep[endpoint] !== undefined) {
                return ep[endpoint].node;
            }
            return "";
        }

        ep = {
            "tourney": _m("tourney", "tourneys/%s.json"),
            "matches": _m("matches", "tourneys/%s/matches.json")
        };

        return {
            "node": _n,
            "path": _p,
            "get": function(endpoint, args, callback) {
                var url, node;
                if (typeof callback !== "function" || !Array.isArray(args)) return;

                args.unshift(endpoint);

                url = _p.apply(this, args);
                node = _n(endpoint);

                $.getJSON( url, function( json ) {
                    if (json[node] !== undefined) {
                        callback(json[node]);
                    }
                });
            }
        };
    })();


    function _getEntity(endpoint, args, callback) {
        var url, node;
        if (typeof callback !== "function" || !Array.isArray(args)) return;

        args.unshift(endpoint);

        url = api.path.apply(this, args);
        node = api.node(endpoint);

        $.getJSON( url, function( json ) {
            if (json[node] !== undefined) {
                callback(json[node]);
            }
        });
    }

    function _getEntities(endpoint, args, callback) {
        if (typeof callback !== "function" || !Array.isArray(args)) return;

        args.unshift(endpoint);

        url = api.path.apply(this, args);
        node = api.node(endpoint);

    }

    function _processTourney() {
        var date, time, t;
        if (self.tourney() === undefined) return;

        date = new Date(self.tourney().date);
        self.tourneyDate(date.toDateString());

        if (self.tourney().events != null) {
            events = ko.utils.parseJson(self.tourney().events);
            if (events.start_time != null) {                
                self.tourneyStartTime(events.start_time);
            }
        }
    }


    self.mainBlockTemplateOptions = ko.observable(initTemplateOptions);
    self.topBlockTemplateOptions = ko.observable(initTemplateOptions);
    self.tourney = ko.observable();
    self.tourneyDate = ko.observable();
    self.tourneyStartTime = ko.observable();
    self.matches = ko.observableArray();
    while (self.matches().length < 5) {
        self.matches.push(matchDefaultContent);
    }
 

    self.addMatch = function() {

    }


    api.get("tourney", [tourney_id], function(json) {
        self.tourney(json);
        _processTourney();
        self.topBlockTemplateOptions(topBlockTemplateOptions)
        self.mainBlockTemplateOptions(mainBlockTemplateOptions)
    })

    api.get("matches", [tourney_id], function(json) {
        console.log(json);
//]        self.matches(json);
    });

}

ko.applyBindings(new NewTourneyModel(), document.getElementById('main'));

</script>

{% endblock %}

{% block body %}
    <!-- ko template: topBlockTemplateOptions --><!-- /ko -->
    <!-- ko template: mainBlockTemplateOptions --><!-- /ko -->

<script type="text/html" id="top_template">
    <h6 class="text-center"><span data-bind="text: tourneyDate"></span> <span data-bind="text: tourneyStartTime"></span></h6>
    <h3 class="text-center"><span data-bind="text: tourney().home_team.name"></span> <small>(Home)</small><br/><small>vs.</small><br/><span data-bind="text: tourney().away_team.name"></span> <small>(Away)</small></h3>
</script>

<script type="text/html" id="match_list_template">
    <p>
        <a class="btn btn-default btn-xs" data-bind="click: addMatch">Start Match</a>
    </p>
    <table>
        <tbody>
        <!-- ko foreach: {data: matches, as: 'match'} -->
            <tr>
                <td><span data-bind="text: match.id"></span></td>
            </tr>
        <!-- /ko -->
        </tbody>
    </table>
</script>

<script type="text/html" id="match_add_template">

</script>


{% endblock %}
