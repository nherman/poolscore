{% extends "master.html" %}
{% set body_class = "root-context" %}

{% block script %}
<script type="text/javascript">
function NewTourneyModel() {
    var self = this,
    userId = "{{session.user_id}}",
    tourney_id = "{{ tourney_id }}",
    api = (function() {
        var ep, root = "/api/v1.0/";

        function _m(n,p) {
            return {"path":root + p,"node": n};
        }

        function _p(endpoint) {
            var i=1, p;
            if (ep[endpoint] === undefined) return "";
            p = ep[endpoint].path;

            while(i < arguments.length) {
                p = p.replace(/%s/,arguments[i++]);
            }

            return p;
        }

        function _n(endpoint) {
            if (ep[endpoint] !== undefined) {
                return ep[endpoint].node;
            }
            return "";
        }

        ep = {
            "tourney": _m("tourney", "tourneys/%s.json"),
            "matches": _m("matches", "tourneys/%s/matches.json")
        };

        return {
            "node": _n,
            "path": _p,
            "get": function(endpoint, args, callback) {
                var url, node;
                if (typeof callback !== "function" || !Array.isArray(args)) return;

                args.unshift(endpoint);

                url = _p.apply(this, args);
                node = _n(endpoint);

                $.getJSON( url, function( json ) {
                    if (json[node] !== undefined) {
                        callback(json[node]);
                    }
                });
            }
        };
    })(),

    mainBlockTemplateDefault = {
        "name": "main_template",
        "data": self
    };


    function _getEntity(endpoint, args, callback) {
        var url, node;
        if (typeof callback !== "function" || !Array.isArray(args)) return;

        args.unshift(endpoint);

        url = api.path.apply(this, args);
        node = api.node(endpoint);

        $.getJSON( url, function( json ) {
            if (json[node] !== undefined) {
                callback(json[node]);
            }
        });
    }

    function _getEntities(endpoint, args, callback) {
        if (typeof callback !== "function" || !Array.isArray(args)) return;

        args.unshift(endpoint);

        url = api.path.apply(this, args);
        node = api.node(endpoint);

    }

    function _processTourney() {
        var date, time, t;
        if (self.tourney() === undefined) return;

        date = new Date(self.tourney().date);
        self.tourneyDate(date.toDateString());

        if (self.tourney().events != null) {
            events = ko.utils.parseJson(self.tourney().events);
            if (events.start_time != null) {                
                self.tourneyStartTime(events.start_time);
            }
        }
    }



    self.mainBlockTemplateOptions = ko.observable({ "name": "" });
    self.tourney = ko.observable();
    self.tourneyDate = ko.observable();
    self.tourneyStartTime = ko.observable();
    self.matches = ko.observableArray();



    api.get("tourney", [tourney_id], function(json) {
        self.tourney(json);
        _processTourney();
        self.mainBlockTemplateOptions(mainBlockTemplateDefault)

    })

    api.get("matches", [tourney_id], function(json) {
        self.matches(json);
        console.log(self.matches());
    });

}

ko.applyBindings(new NewTourneyModel(), document.getElementById('main'));

</script>

{% endblock %}

{% block body %}

    <h1 class="text-center">Play</h1>  

    <!-- ko template: mainBlockTemplateOptions --><!-- /ko -->

<script type="text/html" id="main_template">
    <h3 class="text-center"><span data-bind="text: tourney().home_team.name"></span> <small>vs.</small> <span data-bind="text: tourney().away_team.name"></span></h3>
    <h6 class="text-center"><span data-bind="text: tourneyDate"></span> <span data-bind="text: tourneyStartTime"></span></h6>


    <table class="table beartalk-list-table">
        <tbody>
        <!-- ko foreach: {data: matches, as: 'match'} -->
            <tr>
                <td><span data-bind="text: match.id"></span></td>
            </tr>
        <!-- /ko -->
        </tbody>
    </table>

</script>


{% endblock %}
