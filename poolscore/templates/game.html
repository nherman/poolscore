{% extends "master.html" %}
{% set body_class = "tourney-context" %}

{% block script %}
    {% autoescape false %}
    <script>
        var gameJSON = {{g.gameJSON}},
            eventsJSON = {{g.eventsJSON}};

            console.log(gameJSON);
            console.log(eventsJSON);
        function gameModel() {
            var self = this;

            /* create closure so subscription callback can capture the event name */
            function subscriptionCallbackFactory(eventName) {
                return function(newValue) {
                    console.log(eventName);
                    self.updateEvent(eventName,newValue);
                }
            }

            /* Add 'x' to an int value like innings, coaches, etc */
            function stepInt(name,x) {
                var obj = self.events[name], val;
                if (typeof obj === "function" && typeof x === "number") {
                    val = obj()+x;
                    if (val >= 0) {
                        obj(val);
                    }
                }
            }

            /* game entity */
            self.game = ko.mapping.fromJS(gameJSON);
            /* event values for this game */
            self.events = ko.mapping.fromJS(eventsJSON);

            /* subscriptions update server when event values change */
            for (key in self.events) {
                if (ko.isObservable(self.events[key])) {
                    self.events[key].subscribe(subscriptionCallbackFactory(key));
                }
            }

            /* save game when winner is selected */
            self.game["winner"].subscribe(function(value) {
                self.saveGame();
            });

            /* sync server-side game entity values to view model values */
            self.saveGame = function(callback) {
                callback = callback || function() {}

                $.ajax("/tournament/match/game", {
                    "contentType": "application/json; charset=UTF-8",
                    "type": "POST",
                    "data": ko.toJSON(self.game), 
                    "complete": function(data) {
                        /* re-map the entire game object. Ensures client viewmodel matches server-side model */
                        ko.mapping.fromJSON(data.responseText, self.game);
                        callback();
                    }
                })
            };

            /* update server when a game event is recorded */
            self.updateEvent = function(eventName, eventValue) {
                var data = {
                        "id": self.game.id(),
                        "name": eventName,
                        "value": eventValue
                    };

                $.ajax("/tournament/match/game/event", {
                    "contentType": "application/json; charset=UTF-8",
                    "type": "POST",
                    "data": ko.toJSON(data), 
                    "error": function(data) {
                        console.log(data);
                    }
                })

            };

            /* add one */
            self.increment = function(name) {
                stepInt(name,1);
            }

            /* subtract one */
            self.decrement = function(name) {
                stepInt(name,-1);
            }

            self.endGame = function(winner) {
                if (self.game["winner"] != null) {
                    self.game["in_progress"] = false;
                    self.saveGame(function() {
                        location.href = "/tournament/match?mid={{ g.match.id }}";
                    });  
                }
            };

        }

        $(function() {
            ko.applyBindings(new gameModel());
        });
    </script>
    {% endautoescape %}
{% endblock %}

{% block body %}

    {% include 'tourney_header.html' %}
    <h2>Game #{{ g.game.ordinal }} <small class="in-progress" data-bind="if: game.in_progress">IN PROGRESS</small></h2>
    <h2 class="text-center">Innings: <span data-bind="text: events.innings">0</span></h2>
    <div class="row" style="margin-bottom:24px;">
        <div class="col-xs-2 col-xs-offset-4 text-right">
            <p>
                <button type="button" class="btn btn-default" data-bind="click: decrement.bind($data,'innings'), css: {'disabled':events.innings() < 1}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
            </p>
        </div>
        <div class="col-xs-2 text-left">
            <p>
                <button type="button" class="btn btn-primary" data-bind="click: increment.bind($data,'innings')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
            </p>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6">
            <div class="panel panel-default game-data">
                <div class="panel-heading">
                    <h3 class="panel-title">HOME<br/><small>{{ g.home_players[0].firstname}} {{ g.home_players[0].lastname}} ({{ g.home_players[0].handicap }})</small></h3>
                    <div class="win-icon" data-bind="visible: game.winner() == 'home'"><span class="glyphicon glyphicon-star" aria-hidden="true"></span></div>
                </div>
                <div class="panel-body">
                    <div class="radio">
                        <label>
                            <input type="radio" name="break" value="home" data-bind="checked: events.breaker, checkedValue: {{g.home_players[0].id}}"/>
                            {{ g.home_players[0].firstname}} Broke
                        </label>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="winner" value="home" data-bind="checked: game.winner"/>
                            {{ g.home_players[0].firstname}} Won
                        </label>
                    </div>
                    <h3>Coaches</h3>
                    <p class="text-center clearfix">
                        <button type="button" class="btn btn-default btn-sm pull-left" data-bind="click: decrement.bind($data,'home_coaches'), css: {'disabled':events.home_coaches() < 1}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-primary btn-sm pull-right" data-bind="click: increment.bind($data,'home_coaches')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                       <span class="h3" data-bind="text: events.home_coaches">0</h3>
                    </p>
                    <h3>Safes</h3>
                    <p class="text-center clearfix">
                        <button type="button" class="btn btn-default btn-sm pull-left" data-bind="click: decrement.bind($data,'home_safes'), css: {'disabled':events.home_safes() < 1}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-primary btn-sm pull-right" data-bind="click: increment.bind($data,'home_safes')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                       <span class="h3" data-bind="text: events.home_safes">0</h3>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xs-6" data-bind="">
            <div class="panel panel-default game-data">
                <div class="panel-heading">
                    <h3 class="panel-title">AWAY<br/><small>{{ g.away_players[0].firstname}} {{ g.away_players[0].lastname}} ({{ g.away_players[0].handicap }})</small></h3>
                    <div class="win-icon" data-bind="visible: game.winner() == 'away'"><span class="glyphicon glyphicon-star" aria-hidden="true"></span></div>
                </div>
                <div class="panel-body">
                    <div class="radio">
                        <label>
                            <input type="radio" name="break" value="away" data-bind="checked: events.breaker, checkedValue: {{g.away_players[0].id}}"/>
                            {{ g.away_players[0].firstname}} Broke 
                        </label>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="winner" value="away" data-bind="checked: game.winner"/>
                            {{ g.away_players[0].firstname}} Won
                        </label>
                    </div>
                    <h3>Coaches</h3>
                    <p class="text-center clearfix">
                        <button type="button" class="btn btn-default btn-sm pull-left" data-bind="click: decrement.bind($data,'away_coaches'), css: {'disabled':events.away_coaches() < 1}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-primary btn-sm pull-right" data-bind="click: increment.bind($data,'away_coaches')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                       <span class="h3" data-bind="text: events.away_coaches">0</h3>
                    </p>
                    <h3>Safes</h3>
                    <p class="text-center clearfix">
                        <button type="button" class="btn btn-default btn-sm pull-left" data-bind="click: decrement.bind($data,'away_safes'), css: {'disabled':events.away_safes() < 1}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-primary btn-sm pull-right" data-bind="click: increment.bind($data,'away_safes')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                       <span class="h3" data-bind="text: events.away_safes">0</h3>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-6 text-center">
            <a class="btn-new-game" href="/tournament/match?mid={{ g.match.id }}">Return to Match</a>
        </div>
        <div class="col-xs-6 text-center">
            <button type="button" class="btn-end-match" data-bind="click: endGame, css: {'disabled':game.winner() == null}">End Game</button>
        </div>
    </div>

{% endblock %}

